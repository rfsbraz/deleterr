# Integration tests workflow - runs Deleterr against real Radarr/Sonarr containers
name: Integration Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "develop"
      - "main"

permissions:
  contents: read

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-timeout
        pip install -r requirements.txt

    - name: Create Tautulli database
      run: |
        cd tests/integration/seed_data/tautulli
        python create_db.py

    - name: Start Docker Compose services
      run: |
        cd tests/integration
        docker compose -f docker-compose.integration.yml up -d --build

    - name: Fix volume permissions for linuxserver containers
      run: |
        # linuxserver.io containers run as user abc (UID 1000)
        # Fix permissions on media volumes so containers can write to them
        docker exec deleterr-test-radarr chown -R abc:abc /movies || true
        docker exec deleterr-test-sonarr chown -R abc:abc /tv || true

        # Also ensure the directories exist with proper permissions
        docker exec deleterr-test-radarr mkdir -p /movies && docker exec deleterr-test-radarr chown abc:abc /movies || true
        docker exec deleterr-test-sonarr mkdir -p /tv && docker exec deleterr-test-sonarr chown abc:abc /tv || true

    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to start..."

        # Wait for Plex mock (fastest)
        echo "Waiting for Plex mock..."
        timeout 60 bash -c 'until curl -sf http://localhost:32400/health; do sleep 2; done'
        echo "Plex mock is ready"

        # Wait for Radarr
        echo "Waiting for Radarr..."
        timeout 120 bash -c 'until curl -sf http://localhost:7878/ping; do sleep 2; done'
        echo "Radarr is ready"

        # Wait for Sonarr
        echo "Waiting for Sonarr..."
        timeout 120 bash -c 'until curl -sf http://localhost:8989/ping; do sleep 2; done'
        echo "Sonarr is ready"

        # Wait for Tautulli
        echo "Waiting for Tautulli..."
        timeout 120 bash -c 'until curl -sf http://localhost:8181/status; do sleep 2; done'
        echo "Tautulli is ready"

        echo "All services are ready!"

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --timeout=300 -m integration
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Collect Docker logs on failure
      if: failure()
      run: |
        cd tests/integration
        echo "=== Radarr logs ==="
        docker compose -f docker-compose.integration.yml logs radarr || true
        echo ""
        echo "=== Sonarr logs ==="
        docker compose -f docker-compose.integration.yml logs sonarr || true
        echo ""
        echo "=== Tautulli logs ==="
        docker compose -f docker-compose.integration.yml logs tautulli || true
        echo ""
        echo "=== Plex mock logs ==="
        docker compose -f docker-compose.integration.yml logs plex-mock || true

    - name: Stop Docker Compose services
      if: always()
      run: |
        cd tests/integration
        docker compose -f docker-compose.integration.yml down -v --remove-orphans
